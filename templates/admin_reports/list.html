{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block content %}
<div class="container py-4">

  <!-- Page Heading -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">{% trans "Reports List" %}</h2>
    <a href="{% url 'report_create' %}" class="btn btn-success">
      <i class="bi bi-plus-circle"></i> {% trans "Add Report" %}
    </a>
  </div>

  <!-- Toggle Search Button -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#searchCollapse" aria-expanded="false" aria-controls="searchCollapse">
      <i class="bi bi-funnel"></i> {% trans "Advanced Search" %}
    </button>
  </div>

  <!-- Search Form -->
  <div class="collapse mb-4" id="searchCollapse">
    <div class="card shadow-sm border">
      <div class="card-body">
        <form method="GET" dir="{% get_current_language_bidi as bidi %}{% if bidi %}rtl{% else %}ltr{% endif %}">
          <div class="row">
            <div class="col-md-6">
              <label for="company" class="form-label">{% trans "Report Company" %}</label>
              <select class="form-select" name="company" id="company">
                <option value="">{% trans "All Companies" %}</option>
                {% for comp in companies %}
                  <option value="{{ comp.id }}" {% if request.GET.company == comp.id|stringformat:"s" %}selected{% endif %}>
                    {{ comp.name }}
                    {% if LANGUAGE_CODE == "ar" %}
                    {{ comp.Arabic_Value }}
                    {% else %}
                    {{ comp.English_Value }}
                    {% endif %}
                  </option>
                {% endfor %}
              </select>

              <label for="author" class="form-label mt-3">{% trans "Report Author" %}</label>
              <input type="text" class="form-control" name="author" id="author" value="{{ request.GET.author }}" placeholder="{% trans 'Enter author name' %}">

              <label for="report_id" class="form-label mt-3">{% trans "Report ID" %}</label>
              <input type="text" class="form-control" name="report_id" id="report_id" value="{{ request.GET.report_id }}" placeholder="{% trans 'Enter report ID' %}">
            </div>

            <div class="col-md-6">
              <label for="title" class="form-label">{% trans "Report Title" %}</label>
              <input type="text" class="form-control" name="title" id="title" value="{{ request.GET.title }}" placeholder="{% trans 'Enter report title' %}">

              <label for="report_type" class="form-label mt-3">{% trans "Report Type" %}</label>
              <input type="text" class="form-control" name="report_type" id="report_type" value="{{ request.GET.report_type }}" placeholder="{% trans 'Enter report type' %}">

              <label for="year" class="form-label mt-3">{% trans "Year" %}</label>
              <input type="text" class="form-control" name="year" id="year" value="{{ request.GET.year }}" placeholder="{% trans 'Enter year eg. 2025 .. ' %}">
            </div>
          </div>

          {% get_current_language_bidi as bidi %}
          <div class="mt-3 {% if bidi %}text-start{% else %}text-end{% endif %}">
            <a href="{% url request.resolver_match.view_name %}" class="btn btn-secondary">
                <i class="bi bi-arrow-clockwise"></i> {% trans "Reset" %}
              </a>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-search"></i> {% trans "Search" %}
            </button>
           
          </div>
          
        </form>
      </div>
    </div>
  </div>

  <!-- Report Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover shadow-sm border rounded">
      <thead class="table-primary">
        <tr>
          <th>{% trans "Report ID" %}</th>
          <th>{% trans "Report Title" %}</th>
          <th>{% trans "Year" %}</th>
          <th>{% trans "Report Type" %}</th>
          <th class="text-center"><i class="bi bi-gear"></i> {% trans "Actions" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for report in reports %}
          <tr>
            <td>{{ report.Library_Reference }}</td>
            <td>
              {% if LANGUAGE_CODE == "ar" %}
                {{ report.Title_ar }}
              {% else %}
                {{ report.Title }}
              {% endif %}
            </td>
            <td>{{ report.Date_Issue }}</td>
            <td>
              {% if LANGUAGE_CODE == "ar" %}
                {{ report.Type_of_report_ID.Arabic_Value }}
              {% else %}
                {{ report.Type_of_report_ID.English_Value }}
              {% endif %}
            </td>
            <td class="text-center">
              <!-- <a href="{% url 'report_detail' report.Library_Reference %}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-info-circle"></i> {% trans "Details" %}
              </a> -->
              <a href="{% url 'report_update' report.Library_Reference %}" class="btn btn-sm btn-outline-warning">
                <i class="bi bi-pencil-square"></i> {% trans "Edit" %}
              </a>
              <a href="{% url 'report_delete' report.Library_Reference %}" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-trash"></i> {% trans "Delete" %}
              </a>
            </td>
          </tr>

          <!-- Optional Related Documents Row -->
          <tr class="collapse" id="related{{ report.Library_Reference }}">
            <td colspan="5">
              <strong>{% trans "Related Documents in" %} 
                {% if LANGUAGE_CODE == "ar" %}
                  {{ report.Type_of_report_ID.Arabic_Value }}
                {% else %}
                  {{ report.Type_of_report_ID.English_Value }}
                {% endif %}
                :</strong>
              <ul class="mb-0">
                {% for related in report.related_documents %}
                  <li>
                    <a href="{% url 'report_detail' related.Library_Reference %}">
                      {% if LANGUAGE_CODE == "ar" %}
                        {{ related.Title_ar }}
                      {% else %}
                        {{ related.Title }}
                      {% endif %}
                    </a> ({{ related.Date_Issue }})
                  </li>
                {% empty %}
                  <li class="text-muted">{% trans "No related documents available." %}</li>
                {% endfor %}
              </ul>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" class="text-center text-muted">{% trans "No reports found." %}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if reports.has_other_pages %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
  
      {# Previous button #}
      {% if reports.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ reports.previous_page_number }}{{ query_params }}">{% trans "Previous" %}</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">{% trans "Previous" %}</span></li>
      {% endif %}
  
      {# Page numbers with smart ellipsis #}
      {% for i in reports.paginator.page_range %}
        {% if i == 1 or i == reports.paginator.num_pages or i == reports.number or i == reports.number|add:"-1" or i == reports.number|add:"1" %}
          {% if i == reports.number %}
            <li class="page-item active"><span class="page-link">{{ i }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ i }}{{ query_params }}">{{ i }}</a></li>
          {% endif %}
        {% elif i == 2 and reports.number > 4 %}
          <li class="page-item disabled"><span class="page-link">…</span></li>
        {% elif i == reports.paginator.num_pages|add:"-1" and reports.number < reports.paginator.num_pages|add:"-3" %}
          <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
      {% endfor %}
  
      {# Next button #}
      {% if reports.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ reports.next_page_number }}{{ query_params }}">{% trans "Next" %}</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">{% trans "Next" %}</span></li>
      {% endif %}
  
    </ul>
  </nav>
  {% endif %}  

</div>
{% endblock %}
