{% extends 'base.html' %}
{% block title %}Home | SGS Report Search{% endblock %}
{% load i18n %}
{% block content %}



<!-- Add Animate.css -->
{% load static %}
<link rel="stylesheet" href="{% static 'css/vendor/animate.min.css' %}"/>
<div class="text-center py-5 background-image">

    <h1 class="fw-bold text-primary mb-3" style="color:white !important">{% trans "Bibliographic Database" %}</h1>
    <p class="lead" style="font-weight: 900;">{% trans "Publications of Saudi Geological Survey including books, maps reports, technical reports and open file reports." %}</p>

    <!-- Basic Search -->
    <form method="GET" class="d-flex flex-wrap justify-content-center mb-3">
        <input type="text" name="q" class="form-control w-50 me-2 shadow-sm {% if request.GET.q %}highlight{% endif %}"
               placeholder="{% trans 'Search by Title of the Report , or Report ID  or keywords ....' %}" value="{{ request.GET.q }}">
        <button type="submit" class="btn btn-primary px-4 me-2" style="background-color:var(--main-color); border:none">{% trans "Quick Search" %}</button>
        {% if request.GET %}
        <a href="{% url 'home' %}" class="btn btn-outline-secondary px-4 advancedSearch me-2" >{% trans "Reset Filters" %}</a>
        {% endif %}
    </form>

    <!-- Advanced Search Toggle -->
    <div class="text-center mb-1">
        <button class="btn btn-outline-secondary advancedSearch" type="button" data-bs-toggle="modal" data-bs-target="#advancedSearchModal">
            {% trans "Advanced Search" %}
        </button>
    </div>




    <div class="text-center py-5 ">
<div class="container mb-3">
    <div class="top-reading-section p-4 rounded shadow-sm bg-white animate__animated animate__fadeInUp">
        <h3 class="text-primary mb-4 border-bottom pb-2" style="color: var(--main-color) !important;">{% trans "Top Reading" %}</h3>
        <ul class="list-group list-group-flush">
            {% for report in top_reports %}
                <li class="list-group-item d-flex justify-content-between align-items-center py-1 top-reading-item">
                  <a class="text-decoration-none text-dark fw-medium hover-link d-inline-flex align-items-center"
                  href="{% url 'report_detail' report.pk %}"
                  style="max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
               
                   <i class="bi bi-file-earmark-text me-2 text-primary flex-shrink-0"></i>
               
                   {% if LANGUAGE_CODE == "ar" %}
                       <span class="text-truncate" style="max-width: calc(100% - 40px);">
                           {{ report.Title_ar }}
                       </span>
                       &nbsp;|&nbsp;
                       <span style="font-weight: 900;">بواسطة</span> {{ report.company.Arabic_Value }}
                   {% else %}
                       <span class="text-truncate" style="max-width: calc(100% - 40px);">
                           {{ report.Title }}
                       </span>
                       &nbsp;|&nbsp;
                       <span style="font-weight: 900;">BY</span> {{ report.company }}
                   {% endif %}
               </a>
                    <span class="badge bg-primary bg-gradient rounded-pill px-3 py-2 animate__animated animate__fadeInUp" style="background-color: var(--main-color) !important; animation-delay: 0.6s;">
                        {% trans "number of reading" %} : {{ report.read_count }} 
                    </span>
                </li>
            {% empty %}
                <li class="list-group-item text-muted">{% trans "No data available yet." %}</li>
            {% endfor %}
        </ul>
    </div>
</div>



     <!-- Animated Cards Section -->
<div class="container mt-5">
    <div class="row text-center g-4  mt-5">
        <!-- Card 1 -->
        <div class="col-md-4 mb-4">
            <div class="card-sgs-enhanced h-100 shadow-lg border-0 animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                <div class="card-icon-container">
                    <i class="bi bi-search icon-animate"></i>
                </div>
                <div class="card-body p-4 pt-5 mt-3">
                    <h4 class="card-title mb-3 title-animate"style="color: black;" >{% trans "Quick Search" %}</h4>
                    <p class="card-text text-animate "style="color: black;">{% trans "Instantly find reports by title or keywords." %}</p>
                </div>
            </div>
        </div>

        <!-- Card 2 -->
        <div class="col-md-4 mb-4">
            <div class="card-sgs-enhanced h-100 shadow-lg border-0 animate__animated animate__fadeInUp" style="animation-delay: 0.4s;">
                <div class="card-icon-container">
                    <i class="bi bi-file-earmark-pdf icon-animate"></i>
                </div>
                <div class="card-body p-4 pt-5 mt-3">
                    <h4 class="card-title mb-3 title-animate" style="color: black;">{{count}}+ {% trans "PDF Reports" %}</h4>
                    <p class="card-text text-animate" style="color:black">{% trans "Access original and verified SGS geological documents." %}</p>
                </div>
            </div>
        </div>

        <!-- Card 3 -->
        <div class="col-md-4 mb-4">
            <div class="card-sgs-enhanced h-100 shadow-lg border-0 animate__animated animate__fadeInUp" style="animation-delay: 0.6s;">
                <div class="card-icon-container">
                    <i class="bi bi-journals icon-animate"></i>
                </div>
                <div class="card-body p-4 pt-5 mt-3">
                    <h4 class="card-title mb-3 title-animate" style="color: black;">{{total_appendices}}+ {% trans "Documents" %}</h4>
                    <p class="card-text text-animate"style="color: black;">{% trans "Browse a vast archive of official SGS reports." %}</p>
                </div>
            </div>
        </div>
    </div>
</div>

    </div>
   

    <div class="modal fade" id="advancedSearchModal" tabindex="-1" aria-labelledby="advancedSearchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="modal-content" dir="{% get_current_language_bidi as bidi %}{% if bidi %}rtl{% else %}ltr{% endif %}">
            <form method="GET">
              <div class="modal-header">
                <h5 class="modal-title" id="advancedSearchModalLabel">{% trans "Advanced Search" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <!-- Left Column -->
                  <div class="col-md-6">
                    <label for="company" class="form-label">{% trans "Report Company" %}</label>
                    <select class="form-select {% if request.GET.company is not None %}highlight{% endif %}" name="company" id="company">
                        <option value=""
                        {% if  not request.GET.company %}
                          selected
                        {% endif %}
                      >{% trans "All Companies" %}</option>
                        
                        {% for comp in companies %}
                          <option value="{{ comp.id|stringformat:"s" }}" {% if request.GET.company == comp.id|stringformat:"s" %}selected{% endif %}>
                            {% if LANGUAGE_CODE == "ar" %}
                              {{ comp.Arabic_Value }}
                            {% else %}
                              {{ comp.English_Value }}
                            {% endif %}
                          </option>
                        {% endfor %}
                      </select>
                      
                      
      
                    <label for="author" class="form-label mt-3">{% trans "Report Author" %}</label>
                    <input type="text" class="form-control {% if request.GET.author %}highlight{% endif %}" name="author" id="author"
                      value="{{ request.GET.author }}" placeholder="{% trans 'Enter author name' %}">
      
                    <label for="report_id" class="form-label mt-3">{% trans "Report ID" %}</label>
                    <input type="text" class="form-control {% if request.GET.report_id %}highlight{% endif %}" name="report_id" id="report_id"
                      value="{{ request.GET.report_id }}" placeholder="{% trans 'Enter report ID' %}">
                  </div>
      
                  <!-- Right Column -->
                  <div class="col-md-6">
                    <label for="title" class="form-label">{% trans "Report Title" %}</label>
                    <input type="text" class="form-control {% if request.GET.title %}highlight{% endif %}" name="title" id="title"
                      value="{{ request.GET.title }}" placeholder="{% trans 'Enter report title' %}">
      
                      <label for="report_type" class="form-label mt-3">{% trans "Report Type" %}</label>
                      <select class="form-select {% if request.GET.report_type is not None %}highlight{% endif %}" name="report_type" id="report_type">
                        <option value="">{% trans "All Report Types" %}</option>
                        {% for rtype in report_types %}
                          <option value="{{ rtype.id }}"
                              {% if request.GET.report_type == rtype.id|stringformat:"s" %}selected{% endif %}>
                              {% if LANGUAGE_CODE == "ar" %}
                                  {{ rtype.Arabic_Value }}
                              {% else %}
                                  {{ rtype.English_Value }}
                              {% endif %}
                          </option>
                        {% endfor %}
                      </select>
      
                    <label for="year" class="form-label mt-3">{% trans "Year" %}</label>
                    <input type="text" class="form-control {% if request.GET.year %}highlight{% endif %}" name="year" id="year"
                      value="{{ request.GET.year }}" placeholder="{% trans 'Enter year eg. 2025 .. ' %}">
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">{% trans "Search" %}</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      
</div>

<!-- Results Section -->
<div class="container mt-3">
    {% if not request.GET %}
    <div class="alert alert-info text-center shadow-sm" style="background-color: var(--main-color) !important; color:white">
        <strong>{% trans "Welcome!" %}</strong>{% trans " Use the search form above to explore official SGS reports.!" %}
    </div>
    {% elif reports|length == 0 %}
    <div id="no-results-message" class="alert alert-warning text-center shadow-sm p-4 rounded" style="max-width: 600px; margin: 30px auto; font-size: 1.1rem;">
      <i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem; color: #856404;"></i>
      <strong>{% trans "No reports found." %}</strong><br>
      {% trans "Try adjusting your filters or search criteria and try again." %}
    </div>
    {% else %}
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="text-muted mb-0" style="color: var(--main-color) !important; font-weight: 900;">
          {% trans "Found" %} {{ count }} {% trans "results" %}
      </h5>
      <a href="?{{ request.GET.urlencode }}&export=csv" 
         class="btn btn-sm btn-outline-primary">
          <i class="bi bi-download"></i> {% trans "Export CSV" %}
      </a>
  </div>


    <div class="table-responsive"  id="resultsTable">
        <table class="table table-striped table-hover shadow-sm border rounded">
            <thead class="table-primary ">
                <tr>
                    <th>{% trans "Report ID" %} </th>
                    <th>{% trans "Report Title" %} </th>
                    <th>{% trans "Year" %}</th>
                    <th>{% trans "Report Type" %}</th>
                    <th><i class="bi bi-gear"></i>{% trans "Actions" %} </th>
                </tr>
            </thead>
            <tbody id="appendixAccordion">
              {% for report in reports %}
              <tr>
                  <td class="report-ref">{{ report.Library_Reference }}</td>
                  {% if LANGUAGE_CODE == "ar" %}
                  <td class="report-title">{{ report.Title_ar }}</td>
                  {% else %}
                  <td class="report-title">{{ report.Title }}</td>
                  {% endif %}
                  <td class="report-year">{{ report.Date_Issue }}</td>
                  <td class="report-type" data-id="{{ report.Type_of_report_ID.id }}">
                      {% if LANGUAGE_CODE == "ar" %}
                        {{ report.Type_of_report_ID.Arabic_Value }}
                      {% else %}
                        {{ report.Type_of_report_ID.English_Value }}
                      {% endif %}
                  </td>
                  <td class="text-center">
                      <a href="{% url 'report_detail' report.Library_Reference %}" 
                         class="btn btn-sm btn-outline-primary">
                          <i class="bi bi-info-circle"></i> {% trans "Details" %}
                      </a>
                      <!-- <a data-bs-toggle="collapse" 
                         data-bs-target="#related{{ report.Library_Reference|slugify }}" 
                         class="btn btn-sm btn-outline-secondary">
                          <i class="bi bi-files"></i> {% trans "Appendix" %}
                      </a> -->
                  </td>
              </tr>
              <!-- <tr class="collapse" 
                  id="related{{ report.Library_Reference|slugify }}" 
                  data-bs-parent="#appendixAccordion">
                  <td colspan="6">
                      <strong>{% trans "Related Appendix" %}:</strong>
                      <ul class="mb-0">
                          {% for appendix in report.appendices %}
                          <div>
                              <a href="{% url 'report_detail' report.Library_Reference %}" target="_self">
                                  {{ appendix.filename }}
                              </a>
                          </div>
                          {% empty %}
                          <div class="text-muted">{% trans "No appendices available" %}</div>
                          {% endfor %}
                      </ul>
                  </td>
              </tr> -->
              {% endfor %}
          </tbody>
          
        </table>
    </div>

    {% if reports.has_other_pages %}
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
    
        {# Previous button #}
        {% if reports.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ reports.previous_page_number }}{{ query_params }}">{% trans "Previous" %}</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">{% trans "Previous" %}</span></li>
        {% endif %}
    
        {# Page numbers with smart ellipsis #}
        {% for i in reports.paginator.page_range %}
          {% if i == 1 or i == reports.paginator.num_pages or i == reports.number or i == reports.number|add:"-1" or i == reports.number|add:"1" %}
            {% if i == reports.number %}
              <li class="page-item active"><span class="page-link">{{ i }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="?page={{ i }}{{ query_params }}">{{ i }}</a></li>
            {% endif %}
          {% elif i == 2 and reports.number > 4 %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% elif i == reports.paginator.num_pages|add:"-1" and reports.number < reports.paginator.num_pages|add:"-3" %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
        {% endfor %}
    
        {# Next button #}
        {% if reports.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ reports.next_page_number }}{{ query_params }}">{% trans "Next" %}</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">{% trans "Next" %}</span></li>
        {% endif %}
    
      </ul>
    </nav>
    {% endif %}  
    {% endif %}
</div>








<script>
    document.addEventListener("DOMContentLoaded", function () {
        const inputs = document.querySelectorAll('#advancedSearch input, #advancedSearch select, #advancedSearch textarea');
    
        inputs.forEach(input => {
            // Initial check if value exists (GET request applied previously)
            if (input.value) {
                input.classList.add('highlight');
            }
    
            // Listen for changes
            input.addEventListener('change', function () {
                if (this.value && this.value.trim() !== "") {
                    this.classList.add('highlight');
                } else {
                    this.classList.remove('highlight');
                }
            });
        });
    });


//  script for go with toggle button 
document.addEventListener('DOMContentLoaded', function () {
        const advancedSearchElement = document.getElementById('advancedSearch');

        advancedSearchElement.addEventListener('shown.bs.collapse', function () {
            advancedSearchElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    });


    //  for date picker 
    $(function () {
    $('#year').datepicker({
      format: "yyyy",
      viewMode: "years",
      minViewMode: "years",
      autoclose: true
    });
  });
    </script>



{% if request.GET %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const table = document.getElementById("resultsTable");
        if (table) {
            // Optional delay to ensure the table is rendered
            setTimeout(() => {
                table.scrollIntoView({ behavior: "smooth" });
            }, 300); // 300ms delay
        }
    });
</script>


<!-- this script is used for highlited the search words i used  -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const urlParams = new URLSearchParams(window.location.search);

    const qQuery = urlParams.get("q");
    const titleQuery = urlParams.get("title");
    const reportIdQuery = urlParams.get("report_id");
    const yearQuery = urlParams.get("year");
    const reportTypeId = urlParams.get("report_type");

    function highlightElements(query, selector) {
        if (!query) return;

        const words = query.trim().split(/\s+/).filter(Boolean);
        if (words.length === 0) return;

        const regex = new RegExp("(" + words.join("|") + ")", "gi");
        const elements = document.querySelectorAll(selector);

        elements.forEach(el => {
            const originalText = el.innerHTML;
            const cleanText = originalText.replace(/<mark>(.*?)<\/mark>/g, "$1");
            el.innerHTML = cleanText.replace(regex, '<mark>$1</mark>');
        });
    }

    highlightElements(qQuery, ".report-title, .report-ref");
    highlightElements(titleQuery, ".report-title");
    highlightElements(reportIdQuery, ".report-ref");
    highlightElements(yearQuery, ".report-year");

    // NEW: Highlight report type based on data-id match
    if (reportTypeId) {
        document.querySelectorAll(".report-type").forEach(el => {
            if (el.dataset.id === reportTypeId) {
                const originalText = el.innerHTML;
                el.innerHTML = `<mark>${originalText}</mark>`;
            }
        });
    }
});




// if no result on search scroll down to this div 
document.addEventListener("DOMContentLoaded", function () {
    const noResults = document.getElementById("no-results-message");
    if (noResults) {
      noResults.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  });
    </script>



{% endif %}
{% endblock %}
